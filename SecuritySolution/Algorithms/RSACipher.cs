using System;
using System.Collections.Generic;
using System.Linq;
using System.Numerics;
using System.Text;
using System.Threading.Tasks;
using MathNet.Numerics;

namespace Security.Algorithms
{
    public static class RSACipher
    {
        private static readonly BigInteger P = BigInteger.Parse("780181746383368111282615336428938786929987567889449472823009479939087349436625065722142323765783375128373364782491863064793312362384372399105628276250733932381714819606856612425709254818690394419164440324598688222505972275559347617990301566979120758887801990518664641585762379347201293252793149887412215473029476230647785114138158658106181463127417945859699690378753630523358591247049353344097918070462870983272478090767883012599248632801619676437591459874784944475794124196260887495382785863100551841893633347001652234888503699596705348417105423718762822844820492795500223630617931011641676995517450182750433790736319231894229180530148035134362729837271997911864076444771092343919558134223977777678939876978994444333663497707629412962652724881210890745015207142667859918321256645167618614117080583583012752672111844478064805181469581750885012081145764268142777672492489957048968273204869533130058286082051923837795435067978452332645964375351265697978567422990069003434099548549838008972908112439741407922842519968038426447056596979277005704768913569329491946256946280894284264990323202372803166837927962170483455472536594450821227893171754147063553298885316657743941600206722656511348898377954586070940744870543213988082700646204769");
        private static readonly BigInteger Q = BigInteger.Parse("731275874731680622937893068658519865633071839549391659228481123264329089740214080623306840863110300814924209433625963007117792529753939322296614651967906384980489559342787814691577460108579122496092699973429692210694313454423559347121017062132318205472237293281371678336971709077466059156392673504725464787437740263298817640542220752847198329060104482748341519195265394013305000917841715877941506250692465706135574840646001672773896496311859602611966686951434089625027149819555422218726090068911625673126392782616637585394404606216569807881053881468242182356601230652739673284052239808236654458352742272340186526790873901444993001702951480140311517260613026255578066551789743519608453552354602983734762854328710457789398385634356296603788608251328014384393682594811864442392323899327619712296443801084020399007959909109692859015229221599983821494908710859664728188253172347705513773674641882377933014645216275162086669801699052838903611715340753254455409141100966789952995288094203278872661704076282288490713964407265198293388158969169343061508999272589232113178720969782668773375025233538591208607380950608350382829179530716577606758367499064658141604898766555580664711513348938860556914575461218539739836866780698309888348219087459");
        private static readonly BigInteger PHI = (P - 1) * (Q - 1);
        private static readonly BigInteger D;
        public static readonly BigInteger N = P * Q;
        public static readonly BigInteger E = 65537;
        static RSACipher()
        {
            D = ModInvers(E, PHI);
        }
        public static string Encrypt(string text)
        {
            if (text == null)
                throw new ArgumentNullException("text");
            byte[] textBytes = Encoding.UTF8.GetBytes(text);

            BigInteger textNumber = BytesToBigInteger(textBytes, true);

            BigInteger encryptedNumber = BigInteger.ModPow(textNumber, E, N);

            byte[] encryptedBytes = encryptedNumber.ToByteArray();

            string encryptedText = Convert.ToBase64String(encryptedBytes);
            return encryptedText;
        }
        public static string Decrypt(string encryptedText)
        {
            if (encryptedText == null)
                throw new ArgumentNullException("text");
            byte[] encryptedBytes = Convert.FromBase64String(encryptedText);

            BigInteger encryptedNumber = BytesToBigInteger(encryptedBytes, true);

            var textNumber = BigInteger.ModPow(encryptedNumber, D, N);

            byte[] textBytes = textNumber.ToByteArray();
            string text = Encoding.UTF8.GetString(textBytes);
            return text;
        }
        private static BigInteger BytesToBigInteger(byte[] bytes, bool isUnsigned)
        {
            if (isUnsigned)
            {
                byte[] temp = new byte[bytes.Length + 1];
                Array.Copy(bytes, 0, temp, 0, bytes.Length);
                temp[bytes.Length] = 0;
                return new BigInteger(temp);
            }
            return new BigInteger(bytes);
        }

        private static BigInteger ModInvers(BigInteger a, BigInteger mod)
        {
            BigInteger x;
            BigInteger y;
            ExtendedGcd(a, mod, out x, out y);
            return (x % mod + mod) % mod;
        }

        private static void ExtendedGcd(BigInteger a, BigInteger b, out BigInteger x, out BigInteger y)
        {
            if (b == 0)
            {
                x = 1;
                y = 0;
                return;
            }
            ExtendedGcd(b, a % b, out BigInteger x1, out BigInteger y1);
            x = y1;
            y = x1 - (a / b) * y1;
        }
    }
}
